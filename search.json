[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "cmdstanpy for Regression Monkeys",
    "section": "",
    "text": "Welcome\nこのQuarto Bookは以下のシリーズと連動して運用されています:",
    "crumbs": [
      "Welcome"
    ]
  },
  {
    "objectID": "index.html#references",
    "href": "index.html#references",
    "title": "cmdstanpy for Regression Monkeys",
    "section": "References",
    "text": "References",
    "crumbs": [
      "Welcome"
    ]
  },
  {
    "objectID": "posts/bayesianstatistics101/binomial_toymodel.html",
    "href": "posts/bayesianstatistics101/binomial_toymodel.html",
    "title": "1  ワクチン接種施策とベイジアン意思決定",
    "section": "",
    "text": "感染症有病率推定量と意思決定\nデータに基づいて公衆衛生政策担当者の行う判断を決定(decision)とするとき，その決定は \\(d\\) という変数で上記のように表されています．このとき，決定 \\(d\\) の集合について一般に決定空間とと呼び，多くの場合 \\(D\\) で表されます．\n問題設定より，決定空間 \\(D\\) は\n\\[\nD = \\{\\text{住民へのワクチン接種強制実施}, \\text{住民へのワクチン接種強制不実施}\\}\n\\]\nとなります．\n▶  パラメータ空間\n意思決定にあたって関心があるのは，街で感染した人の割合 \\(\\theta\\) です．大まかに言えば，\\(\\theta\\) のパラメーター空間 \\(\\Theta\\) は0と1の間のすべての値になるので\n\\[\n\\Theta = [0, 1]\n\\]\n▶  損失関数\n地域Aの \\(U = \\text{GDP} - \\text{施策費用}\\) の期待値の最大化問題は，\n\\[\n\\begin{align*}\n\\mathop{\\mathrm{argmax}}_d\\, \\mathbb E[U]\n    &= \\mathbb E[\\sum_{i=1}^{1000} (\\text{GDP}(Y, d)_i - 100d)]\\\\\n    &= \\sum_{i=1}^{1000}\\mathbb E[\\text{GDP}(Y_i, d)_i - 100d]\\\\\n    &= 1000 \\times \\mathbb E[\\text{GDP}(Y_i, d)_i - 100d]\n\\end{align*}\n\\]\nしたがって，\n\\[\n\\mathop{\\mathrm{argmax}}_d\\, \\mathbb E[\\text{GDP}_i(Y_i, d) - 100d]\n\\tag{1.1}\\]\nの問題を解けば良いことがわかります．最大化問題の形式でも良いですが，これを損失関数の形で表現し直します．このとき， \\(c_{ij}\\) を成分とする損失行列 \\(C\\) は\nこのコスト行列をベースにワクチン接種強制についての決定変数 \\(d\\) に応じた損失関数 \\(L(d)\\) を用いて@eq-objective-func を表現し直すと\n\\[\n\\mathop{\\mathrm{argmin}}_d\\, \\mathbb E[L(d)] = \\sum_{j\\in\\{0, 1\\}} C(d, Y_i=j)p(Y_i =j)\n\\]\n\\(d\\) に応じた損失関数 \\(L(d)\\) の期待値を計算すると\n\\[\n\\begin{align*}\n\\mathbb E[L(d=1)] &= 100\\\\\n\\mathbb E[L(d=0)] &= 500 \\times \\mathbb E[Y_i = 1] = 500 \\times p(Y_i = 1)\n\\end{align*}\n\\]\nここから損失最小化問題の解として\n\\[\nd = \\left\\{\\begin{array}{c}\n1 & \\text{if } p(Y_i = 1) &gt; 0.2\\\\\n\\{0, 1\\} & \\text{if } p(Y_i = 1) = 0.2\\\\\n0 & \\text{if } p(Y_i = 1) &lt; 0.2\n\\end{array}\\right.\n\\]\nとなることがわかります．\n▶  \\(p(Y_i=1)\\)と信念\n問題文より\n\\[\nY_i \\overset{\\mathrm{iid}}{\\sim} \\operatorname{Bernoulli}(\\theta)\n\\]\nしたがって，\\(p(Y_i=1) = \\theta\\) となりますが，\\(\\theta\\) は政策担当者にとって未知の変数です．\n一方，\\(\\theta\\) について「少し古い情報だが地域Aと似たような地域では 平均 \\(0.1\\), 区間 \\(0.01\\) から \\(0.25\\) の間で分布している」という情報があります． この政策担当者の \\(\\theta\\) に対する事前の信念が\\(p(\\theta)\\) という形で表現されるとします．このとき，\n\\[\n\\begin{align*}\np(Y_i=1)\n    &= \\int_\\Theta p(Y_i = 1, \\theta) \\,\\mathrm{d} \\theta\\\\\n    &= \\int_\\Theta p(Y_i = 1\\vert \\theta) p(\\theta) \\,\\mathrm{d} \\theta\\\\\n    &= \\int_\\Theta \\theta p(\\theta) \\,\\mathrm{d} \\theta\\\\\n    &= \\mathbb E[\\theta]\n\\end{align*}\n\\]\n「少し古い情報だが地域Aと似たような地域では 平均 \\(0.1\\), 区間 \\(0.01\\) から \\(0.25\\) の間で分布している」を表す政策担当者の信念を表す分布 \\(p(\\theta)\\) は無数に存在し得りますが， 「あやゆるモデルは誤りであるが，いくつかは有用である」(Box and Draper, 11987)という格言に従って，信念を近似する関数を\n\\[\n\\theta \\sim \\operatorname{Beta}(2, 18)\n\\tag{1.2}\\]\nなどで近似し，観察データに基づいて信念を更新，更新された信念に基いて意思決定をしていきます．\n▶  ベータ分布による信念の近似\nEquation 1.2 を政策担当者の信念の近似分布とすると以下のようなPDF, CDFになります．\nCode\nimport numpy as np\nfrom scipy.stats import beta\nimport matplotlib.pyplot as plt\nimport regmonkey_style.stylewizard as sw\n\nsw.set_templates(\"regmonkey_scatter\")\n\na = 2\nb= 18\n\nx = np.linspace(0, 1, 200)\nrv = beta(a, b)\n\nfig, ax1 = plt.subplots(1, 1)\nax2 = ax1.twinx()\n\nax1.plot(x, rv.pdf(x))\nax2.plot(x, rv.cdf(x), color='gray')\nax1.set_xlabel(r'$\\theta$')\nax1.set_ylabel(r'density')\nax2.set_ylabel(r'cumulative probability')\n\nax1.set_ylim(0,)\nax1.set_xlim(-0.01,1)\nax2.set_xlim(-0.01,1)\nax2.set_ylim(0,)\nax1.spines[['right']].set_visible(True)\nax1.set_title(r\"prior distribution of $\\theta$\")\nax1.legend(labels=['pdf'],loc=2, borderaxespad=0., bbox_to_anchor=(1.15, 0.9))\nax2.legend(labels=['cdf'],loc=2, borderaxespad=0., bbox_to_anchor=(1.15, 0.95))\nplt.show()\n\\(X\\sim \\operatorname{Beta}(a, b)\\) とすると，\n\\[\n\\begin{align*}\n\\operatorname{mode}(X) &= \\frac{a-1}{a + b - 2}\\\\\n\\mathbb E[X] &= \\frac{a}{a+b}\n\\end{align*}\n\\]\nであるので，\\(\\mathbb E[\\theta] = \\frac{2}{2+18} = 0.1\\) となるので 「少し古い情報だが地域Aと似たような地域では 平均 \\(0.1\\), 区間 \\(0.01\\) から \\(0.25\\) の間で分布している」という情報をある程度近似していると判断することができます．また，区間 \\(0.01\\) から \\(0.25\\) の確率は\nCode\nfrom IPython.display import display, Markdown\n\nprob = rv.cdf(0.25) - rv.cdf(0.01)\ndisplay(Markdown(rf\"$Pr(0.01 \\leq \\theta \\leq 0.25) = {prob:.4f}$\"))\n\n\n\\(Pr(0.01 \\leq \\theta \\leq 0.25) = 0.9537\\)",
    "crumbs": [
      "Bayesian methods",
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>ワクチン接種施策とベイジアン意思決定</span>"
    ]
  },
  {
    "objectID": "posts/bayesianstatistics101/binomial_toymodel.html#感染症有病率推定量と意思決定",
    "href": "posts/bayesianstatistics101/binomial_toymodel.html#感染症有病率推定量と意思決定",
    "title": "1  ワクチン接種施策とベイジアン意思決定",
    "section": "",
    "text": "Exercise 1.1 \n人口 \\(1000\\) 人からなる地域Aの公衆衛生政策担当者を想定します．とある感染症が世界的に流行しており，公衆衛生担当者として全市民にワクチン接種を強制するか否かの意思決定に直面しています．\n ▶  政策意思決定に関連する情報\n政策意思決定に関連する情報として以下のことがわかっています\n\nワクチンの費用は摂取人数あたり100円（=つまり，ワクチンを矯正すると一人あたり施策実施費用は100円，otherwise 0円）\n健康な人の一人あたりのGDPは1000円だが，感染症に罹患すると500円まで下がる\n感染症に罹患した人にワクチンを投与すると，一人あたりのGDPは500円→1000円まで回復する\n\n ▶  仮定\n地域の住民 \\(i\\) が感染症に罹患しているか否かを表す確率変数 \\(Y_i\\) は\n\\[\nY_i \\overset{\\mathrm{iid}}{\\sim} \\operatorname{Bernoulli}(\\theta)\n\\]\nそして，街全体の感染者人数を\n\\[\nY = \\sum_{i=1}^{1000} Y_i\n\\]\nと表すとします．\\(\\theta\\) は公衆衛生政策担当者にとっては未知であるが，事前の情報として，少し古い情報だが地域Aと似たような地域では 平均 \\(0.1\\), 区間 \\(0.01\\) から \\(0.25\\) の間で分布していることがわかっているとします．\n ▶  直面している意思決定問題\nDecision変数 \\(d\\) を以下のように表すとする\n\\[\n\\begin{align*}\nd = \\left\\{\\begin{array}{c}\n1 & \\text{ワクチン接種強制}\\\\\n0 & \\text{otherwise}\n\\end{array}\\right.  \n\\end{align*}\n\\]\n地域Aの \\(U = \\text{GDP}(Y, d) - \\text{施策費用}\\times d\\) の期待値を最大化する観点から公衆衛生政策担当者は \\(d\\) をどのように決定すればよいか？\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n \n\n\n\n\n\n\n\\(Y_i=1\\)\n\n\n\n\n\\(Y_i=0\\)\n\n\n\n\n\n\n\\(d=1\\)\n\n\n\n\n\\(100\\)\n\n\n\n\n\\(100\\)\n\n\n\n\n\n\n\\(d=0\\)\n\n\n\n\n\\(500\\)\n\n\n\n\n\\(0\\)\n\n\n\n\n\n\n\\(Y_i=0, Y_i=1\\) のどちらでも \\(d=1\\) のときは一人あたりGDPは \\(1000\\), but 施策費用 \\(100\\) が発生 → 損失は \\(100\\)\n\\(Y_i=1\\) のとき \\(d=0\\) は 一人あたりGDPが \\(1000 \\to 500\\) へ下がる → 損失は \\(500\\)",
    "crumbs": [
      "Bayesian methods",
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>ワクチン接種施策とベイジアン意思決定</span>"
    ]
  },
  {
    "objectID": "posts/bayesianstatistics101/binomial_toymodel.html#事前分布の更新",
    "href": "posts/bayesianstatistics101/binomial_toymodel.html#事前分布の更新",
    "title": "1  ワクチン接種施策とベイジアン意思決定",
    "section": "事前分布の更新",
    "text": "事前分布の更新\nワクチン接種強制の意思決定をするにあたって，地域Aの住民から無作為に43人選び感染の検査を行うことにした． 感染者人数がデータ \\(x\\) で表されるとき，その標本空間 \\(\\mathcal{X}\\) は\n\\[\n\\mathcal{X} = \\{0, 1, \\cdots, 43\\}\n\\]\nまた標本モデルは\n\\[\nX \\vert \\theta \\sim \\operatorname{binomial}(43, \\theta)\n\\]\n ▶  ベイズルールに基づく事後分布の更新\nベイズルールより \\(X\\) を観測した後の \\(\\theta\\) に関する事後分布は，\\(p(\\theta)\\) を事前分布とすると\n\\[\np(\\theta\\vert X) = \\frac{p(X\\vert \\theta)p(\\theta)}{p(X)}\n\\]\nまた，\n\\[\n\\begin{align*}\np(X) &= \\int^1_0 {_{n}}C_x \\theta^x(1-\\theta)^{n-x} p(\\theta) \\,\\mathrm{d}\\theta \\\\[8pt]\n&= \\int^1_0 \\frac{_{n}C_x}{B(a, b)} \\theta^x(1-\\theta)^{n-x}\\theta^{a - 1}(1-\\theta)^{b - 1}\\,\\mathrm{d}\\theta\\\\[8pt]\n&=\\int^1_0 \\frac{_{n}C_x}{B(a, b)} \\theta^{a+x-1}(1-\\theta)^{b + n-x - 1}\\,\\mathrm{d}\\theta\\\\\n&= \\frac{_{n}C_x}{B(a, b)}B(a + x, b + n - x)\n\\end{align*}\n\\]\nしたがって，事後分布 \\(p(\\theta\\vert X)\\) は\n\\[\n\\begin{align*}\np(\\theta\\vert X)\n    = \\frac{1}{B(a+x, b+n-x-1)}\\theta^{a+x-1}(1-\\theta)^{b+n-x-1}\n\\end{align*}\n\\]\nよって，事後分布は以下のように更新されます\n\\[\n\\theta\\vert X \\sim \\operatorname{Beta}(a+x, b+n-x)\n\\tag{1.3}\\]\n ▶  cmdstanpyによる推定\n政策担当者が\\(N=43\\) の調査をした結果，サンプルにおける感染者人数 \\(X\\) は \\(11\\) であることがわかったとします．\nEquation 1.2, Equation 1.3 より\n\\[\n\\begin{align*}\n\\mathbb E[\\theta \\vert X] &= \\frac{13}{63} \\approx 0.20635\\\\\n\\operatorname{mode}(\\theta \\vert X) &= \\frac{12}{61} \\approx 0.1967\n\\end{align*}\n\\]\nとなるはずです．これをcmdstanpyで計算します．stan modelを以下のように記述します．\ndata {\n    int&lt;lower=0&gt; N; // number of observations\n    // array[N] int&lt;lower=0, upper=1&gt; Y; // outcomes\n    int&lt;lower=0&gt; X;\n    real&lt;lower=0&gt; alpha; // prior hyperparameter\n    real&lt;lower=0&gt; beta; // prior hyperparameter\n\n}\n\nparameters {\n    real&lt;lower=0, upper=1&gt; theta; // probability of success\n}\n\nmodel {\n    theta ~ beta(alpha, beta); // prior\n    X ~ binomial(N, theta);\n\n}\n\ngenerated quantities {\n    int predicted_y = bernoulli_rng(theta);\n}\n次に，fitさせます．\n\nfrom cmdstanpy import CmdStanModel\n\ndata = {\n \"alpha\": 2,\n \"beta\": 18,\n \"N\" : 43,\n \"X\" : 11\n}\n\nmodel = CmdStanModel(stan_file=\"../../stancode/binomial_toymodel_01.stan\")\nfit = model.sample(data=data, seed=1212)\nfit.summary()\n\n08:15:01 - cmdstanpy - INFO - compiling stan file /home/runner/work/cmdstan_for_regression_monkey/cmdstan_for_regression_monkey/stancode/binomial_toymodel_01.stan to exe file /home/runner/work/cmdstan_for_regression_monkey/cmdstan_for_regression_monkey/stancode/binomial_toymodel_01\n08:15:07 - cmdstanpy - INFO - compiled model executable: /home/runner/work/cmdstan_for_regression_monkey/cmdstan_for_regression_monkey/stancode/binomial_toymodel_01\n08:15:07 - cmdstanpy - INFO - CmdStan start processing\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n                                                                                                                                                                                                                                                                                                                                \n\n\n08:15:07 - cmdstanpy - INFO - CmdStan done processing.\n\n\n\n\n\n\n\n\n\n\n\n\nMean\nMCSE\nStdDev\n5%\n50%\n95%\nN_Eff\nN_Eff/s\nR_hat\n\n\n\n\nlp__\n-32.592600\n0.021198\n0.770842\n-34.073300\n-32.303900\n-32.074400\n1322.35\n22412.8\n1.00144\n\n\ntheta\n0.206433\n0.001319\n0.051222\n0.129039\n0.203101\n0.295836\n1509.17\n25579.1\n1.00249\n\n\npredicted_y\n0.211750\n0.006514\n0.408600\n0.000000\n0.000000\n1.000000\n3934.19\n66681.2\n1.00000\n\n\n\n\n\n\n\n\n\nCode\nimport plotly.figure_factory as ff\n\ntheta_posterior = fit.stan_variable(\"theta\")\n# Create distplot with curve_type set to 'normal'\nfig = ff.create_distplot(\n    [theta_posterior],\n    [\"posterior_theta\"],\n    show_hist=True,\n    bin_size=0.01,\n    show_rug=False,\n)\n\n# Add title\nfig.update_layout(title_text=\"Posterior theta distribution\", yaxis=dict(range=[0, 9]))\n\nfig.show()\n\n\n                                                \n\n\n以上のように \\(\\mathbb E[\\theta\\vert X]\\) は解析解と近しい結果が出力されます． また，\\(\\mathbb E[\\theta\\vert X] &gt; 0.2\\) となるので，事後分布に基づく政策意思決定として，\\(d = 1\\), つまりワクチン接種強制という結論が導かれることになります．",
    "crumbs": [
      "Bayesian methods",
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>ワクチン接種施策とベイジアン意思決定</span>"
    ]
  },
  {
    "objectID": "posts/bayesianstatistics101/chapter_header.html",
    "href": "posts/bayesianstatistics101/chapter_header.html",
    "title": "Bayesian methods",
    "section": "",
    "text": "ベイズ法の考え方\nある集団の特性がパラメーター \\(\\theta\\) として表現されるとします．集団の一部についてデータ \\(y\\) が観測されたとき， その \\(y\\) からの情報はパラメーター \\(\\theta\\) についての不確実性(uncertainty)を減らすことになります． ベイズ推測(Bayesian inference)とはこの不確実性の変化を測ることが直接的な目的となります．\n▶  事前分布と事後分布\n標本空間 \\(\\mathcal{Y}\\), パラメーター空間 \\(\\Theta\\) としたとき，ベイズ学習は \\(y, \\theta\\) に関する信念を \\(\\mathcal{Y}\\) と \\(\\Theta\\) の確率分布によって表現するところから始まります．\nまず，\\(\\theta\\in\\Theta\\) について事前分布 \\(p(\\theta)\\) を設定します． \\(p(\\theta)\\) は，\\(\\theta\\) が母集団の真の特性を表すとどれだけ分析者が信じているか？を表していると解釈できます．\nデータ \\(y\\) が観測された後，ベイズルールに従って \\(\\theta\\) に関する信念を更新します．このとき現れるのが事後分布 \\(p(\\theta\\vert y)\\) ですが，これはデータ \\(y\\) が観測された後に \\(\\theta\\) が真の値であるとどれだけ信じているかを表すことに対応しています．\n▶  ベイズルール\n\\[\np(\\theta\\vert y) = \\frac{p(y\\vert \\theta)p(\\theta)}{\\int_{\\Theta}p(y\\vert \\tilde\\theta)p(\\tilde\\theta)\\,\\mathrm{d}\\tilde\\theta}\n\\]\nベイズルールが示している内容は．事後分布がどうあるべきかではなく，新たな情報を得たときに事後分布はどう変化すべきか？です．",
    "crumbs": [
      "Bayesian methods"
    ]
  },
  {
    "objectID": "posts/bayesianstatistics101/chapter_header.html#ベイズ法の考え方",
    "href": "posts/bayesianstatistics101/chapter_header.html#ベイズ法の考え方",
    "title": "Bayesian methods",
    "section": "",
    "text": "Def: 確率(probability) \nベイズ法における確率(probability) は，未知の量について人々の持つ情報や信念(belief)を表すものと解釈される．",
    "crumbs": [
      "Bayesian methods"
    ]
  }
]